@model Travel.Web.Models.UpdateUser
@{
    ViewData["Title"] = "User Profile";
}

<h2 class="text-center my-4">User Profile</h2>

<div class="container d-flex justify-content-center align-items-start">
    <div class="card shadow p-4" style="width: 100%; max-width: 500px;">
        <form asp-action="UpdateProfile" method="post" id="profileForm">
            <input type="hidden" asp-for="Id" />

            <div class="mb-3">
                <label asp-for="UserName" class="form-label"></label>
                <input asp-for="UserName" class="form-control" disabled />
                <span asp-validation-for="UserName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Email" class="form-label"></label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="FirstName" class="form-label"></label>
                <input asp-for="FirstName" class="form-control" />
                <span asp-validation-for="FirstName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="LastName" class="form-label"></label>
                <input asp-for="LastName" class="form-control" />
                <span asp-validation-for="LastName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="PhoneNumber" class="form-label"></label>
                <input asp-for="PhoneNumber" class="form-control" />
                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-success w-100">Save</button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const token = localStorage.getItem("jwtToken");
        console.log("Token from localStorage:", token);

        function loadProfile() {
            fetch("https://localhost:7172/api/ApplicationUser/me", {
                method: "GET",
                headers: { "Authorization": "Bearer " + token }
            })
            .then(res => res.json())
            .then(data => {
                for (const key in data) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = data[key];
                    }
                }
            });
        }

        function saveProfile() {
            const updatedUser = {
                email: document.getElementById("email").value,
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value,
                phoneNumber: document.getElementById("phoneNumber").value
            };

            fetch("https://localhost:7172/api/ApplicationUser/me", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(updatedUser)
            })
            .then(res => {
                if (res.ok) alert("Profile updated!");
                else alert("Update failed!");
            });
        }

        document.addEventListener("DOMContentLoaded", loadProfile);
    </script>
}